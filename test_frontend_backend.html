<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‰ç«¯å¾Œç«¯åŠŸèƒ½æ¸¬è©¦</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #007bff;
      padding-bottom: 10px;
    }
    h2 {
      color: #555;
      margin-top: 30px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .btn-success {
      background: #28a745;
    }
    .btn-success:hover {
      background: #218838;
    }
    .btn-danger {
      background: #dc3545;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    #result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 6px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 14px;
      max-height: 500px;
      overflow-y: auto;
    }
    .success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    .test-section {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    .test-section h3 {
      margin-top: 0;
      color: #007bff;
    }
    .link-btn {
      display: inline-block;
      margin: 10px 5px;
      padding: 10px 20px;
      background: #6c757d;
      color: white;
      text-decoration: none;
      border-radius: 6px;
    }
    .link-btn:hover {
      background: #5a6268;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ å‰ç«¯å¾Œç«¯åŠŸèƒ½å®Œæ•´æ¸¬è©¦</h1>
    <p>æ­¤å·¥å…·æœƒæ¸¬è©¦å‰ç«¯å ±åå’Œå¾Œå°æäº¤åŠŸèƒ½ï¼Œä¸¦é©—è­‰è³‡æ–™åŒæ­¥</p>
    
    <div style="margin: 20px 0;">
      <a href="http://localhost:5174/register" target="_blank" class="link-btn">ğŸŒ æ‰“é–‹å‰ç«¯å ±åé é¢</a>
      <a href="http://localhost:5174/admin" target="_blank" class="link-btn">ğŸ”§ æ‰“é–‹å¾Œå°ç®¡ç†é é¢</a>
      <a href="https://supabase.com/dashboard/project/kwxlxjfcdghpguypadvi/editor" target="_blank" class="link-btn">ğŸ“Š æŸ¥çœ‹ Supabase è³‡æ–™åº«</a>
    </div>

    <div class="test-section">
      <h3>ğŸ“‹ æ­¥é©Ÿ 1: æª¢æŸ¥ç¾æœ‰è³‡æ–™</h3>
      <button onclick="checkExistingData()">æª¢æŸ¥ Supabase è³‡æ–™</button>
      <div id="existingData"></div>
    </div>

    <div class="test-section">
      <h3>ğŸŒ æ­¥é©Ÿ 2: æ¸¬è©¦å‰ç«¯å ±ååŠŸèƒ½</h3>
      <p>æ¨¡æ“¬å‰ç«¯ç”¨æˆ¶å ±åæäº¤</p>
      <button onclick="testFrontendRegistration()" class="btn-success">æ¸¬è©¦å‰ç«¯å ±å</button>
      <div id="frontendResult"></div>
    </div>

    <div class="test-section">
      <h3>ğŸ”§ æ­¥é©Ÿ 3: æ¸¬è©¦å¾Œå°æäº¤åŠŸèƒ½</h3>
      <p>æ¨¡æ“¬å¾Œå°ç®¡ç†å“¡æ‰‹å‹•æäº¤åå–®</p>
      <button onclick="testBackendSubmission()" class="btn-success">æ¸¬è©¦å¾Œå°æäº¤</button>
      <div id="backendResult"></div>
    </div>

    <div class="test-section">
      <h3>âœ… æ­¥é©Ÿ 4: é©—è­‰è³‡æ–™åŒæ­¥</h3>
      <button onclick="verifyDataSync()" class="btn-success">é©—è­‰æ‰€æœ‰è³‡æ–™</button>
      <div id="syncResult"></div>
    </div>

    <div class="test-section">
      <h3>ğŸ§¹ æ¸…ç†æ¸¬è©¦è³‡æ–™ï¼ˆå¯é¸ï¼‰</h3>
      <button onclick="cleanupTestData()" class="btn-danger">æ¸…ç†æ¸¬è©¦è³‡æ–™</button>
      <div id="cleanupResult"></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://kwxlxjfcdghpguypadvi.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3eGx4amZjZGdocGd1eXBhZHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3ODk5NTMsImV4cCI6MjA4NDM2NTk1M30.0KJIXhxlPOx-5tWQyX12DMNXcWCLc2NmMCyoJY4y024';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function log(elementId, message, type = 'info') {
      const element = document.getElementById(elementId);
      element.className = type;
      element.textContent = message;
      console.log(message);
    }

    async function checkExistingData() {
      log('existingData', 'ğŸ“Š æ­£åœ¨æª¢æŸ¥ Supabase è³‡æ–™...', 'info');
      
      try {
        const { data, error } = await supabase
          .from('registrations')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(10);

        if (error) throw error;

        let message = `âœ… æ‰¾åˆ° ${data.length} ç­†è³‡æ–™\n\n`;
        
        if (data.length > 0) {
          message += 'ğŸ“‹ è³‡æ–™åˆ—è¡¨:\n';
          message += 'â”€'.repeat(80) + '\n';
          data.forEach((reg, index) => {
            const source = reg.admin_note ? 'å¾Œå°' : 'å‰ç«¯';
            message += `${index + 1}. [${source}] ${reg.ref_code}\n`;
            message += `   è¯çµ¡äºº: ${reg.contact_name}\n`;
            message += `   é›»è©±: ${reg.phone}\n`;
            message += `   é¡å‹: ${reg.type}\n`;
            message += `   ç‹€æ…‹: ${reg.status} | ä»˜æ¬¾: ${reg.pay_status}\n`;
            if (reg.admin_note) {
              message += `   ç®¡ç†å“¡å‚™è¨»: ${reg.admin_note}\n`;
            }
            message += `   å»ºç«‹æ™‚é–“: ${new Date(reg.created_at).toLocaleString('zh-TW')}\n`;
            message += 'â”€'.repeat(80) + '\n';
          });
        } else {
          message += 'â„¹ï¸ ç›®å‰æ²’æœ‰è³‡æ–™\n';
        }

        log('existingData', message, 'success');
      } catch (error) {
        log('existingData', `âŒ éŒ¯èª¤: ${error.message}`, 'error');
      }
    }

    async function testFrontendRegistration() {
      log('frontendResult', 'ğŸŒ æ­£åœ¨æ¸¬è©¦å‰ç«¯å ±ååŠŸèƒ½...', 'info');
      
      try {
        const timestamp = Date.now();
        const refCode = 'DINE-0303-' + Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        
        const testData = {
          ref_code: refCode,
          type: 'external',
          headcount: 1,
          attendee_list: [],
          company: 'å‰ç«¯æ¸¬è©¦å…¬å¸',
          title: null,
          contact_name: 'å‰ç«¯æ¸¬è©¦ç”¨æˆ¶' + timestamp,
          phone: '0987654321',
          email: `frontend-test${timestamp}@example.com`,
          line_id: null,
          diet: 'normal',
          diet_other: null,
          allergy_note: null,
          photo_consent: true,
          inviter: null,
          vip_note: null,
          invoice_needed: false,
          invoice_title: null,
          invoice_tax_id: null,
          pay_method: 'transfer',
          pay_status: 'paid',
          pay_proof_url: null,
          status: 'open',
          admin_note: null,
        };

        const { data, error } = await supabase
          .from('registrations')
          .insert(testData)
          .select()
          .single();

        if (error) throw error;

        let message = 'âœ… å‰ç«¯å ±åæˆåŠŸï¼\n\n';
        message += `ğŸ“ å ±åè³‡è¨Š:\n`;
        message += `   å ±åç·¨è™Ÿ: ${data.ref_code}\n`;
        message += `   è¯çµ¡äºº: ${data.contact_name}\n`;
        message += `   é›»è©±: ${data.phone}\n`;
        message += `   Email: ${data.email}\n`;
        message += `   é¡å‹: ${data.type}\n`;
        message += `   ç‹€æ…‹: ${data.status}\n`;
        message += `   ä»˜æ¬¾ç‹€æ…‹: ${data.pay_status}\n`;
        message += `\nâœ… è³‡æ–™å·²æˆåŠŸå¯«å…¥ Supabase è³‡æ–™åº«\n`;
        message += `\nğŸ’¡ æç¤º: ç¾åœ¨å¯ä»¥åœ¨å¾Œå°ã€Œåå–®ç®¡ç†ã€ä¸­çœ‹åˆ°é€™ç­†è³‡æ–™ï¼`;

        log('frontendResult', message, 'success');
      } catch (error) {
        log('frontendResult', `âŒ å‰ç«¯å ±åå¤±æ•—: ${error.message}`, 'error');
      }
    }

    async function testBackendSubmission() {
      log('backendResult', 'ğŸ”§ æ­£åœ¨æ¸¬è©¦å¾Œå°æäº¤åŠŸèƒ½...', 'info');
      
      try {
        const timestamp = Date.now();
        const refCode = 'ADMIN-' + timestamp.toString().slice(-6);
        
        const testData = {
          ref_code: refCode,
          type: 'external',
          headcount: 1,
          attendee_list: [],
          company: 'å¾Œå°æ¸¬è©¦å…¬å¸',
          title: 'æ¸¬è©¦è·ç¨±',
          contact_name: 'å¾Œå°æ¸¬è©¦ç”¨æˆ¶' + timestamp,
          phone: '0912345678',
          email: `backend-test${timestamp}@example.com`,
          line_id: null,
          diet: 'normal',
          diet_other: null,
          allergy_note: null,
          photo_consent: true,
          inviter: null,
          vip_note: null,
          invoice_needed: false,
          invoice_title: null,
          invoice_tax_id: null,
          pay_method: 'transfer',
          pay_status: 'paid',
          pay_proof_url: null,
          status: 'open',
          admin_note: 'é€™æ˜¯å¾å¾Œå°æäº¤çš„æ¸¬è©¦è³‡æ–™',
        };

        const { data, error } = await supabase
          .from('registrations')
          .insert(testData)
          .select()
          .single();

        if (error) throw error;

        let message = 'âœ… å¾Œå°æäº¤æˆåŠŸï¼\n\n';
        message += `ğŸ“ æäº¤è³‡è¨Š:\n`;
        message += `   å ±åç·¨è™Ÿ: ${data.ref_code}\n`;
        message += `   è¯çµ¡äºº: ${data.contact_name}\n`;
        message += `   é›»è©±: ${data.phone}\n`;
        message += `   Email: ${data.email}\n`;
        message += `   é¡å‹: ${data.type}\n`;
        message += `   ç‹€æ…‹: ${data.status}\n`;
        message += `   ä»˜æ¬¾ç‹€æ…‹: ${data.pay_status}\n`;
        message += `   ç®¡ç†å“¡å‚™è¨»: ${data.admin_note}\n`;
        message += `\nâœ… è³‡æ–™å·²æˆåŠŸå¯«å…¥ Supabase è³‡æ–™åº«\n`;
        message += `\nğŸ’¡ æç¤º: ç¾åœ¨å¯ä»¥åœ¨å¾Œå°ã€Œåå–®ç®¡ç†ã€ä¸­çœ‹åˆ°é€™ç­†è³‡æ–™ï¼`;

        log('backendResult', message, 'success');
      } catch (error) {
        log('backendResult', `âŒ å¾Œå°æäº¤å¤±æ•—: ${error.message}`, 'error');
      }
    }

    async function verifyDataSync() {
      log('syncResult', 'âœ… æ­£åœ¨é©—è­‰è³‡æ–™åŒæ­¥...', 'info');
      
      try {
        const { data, error } = await supabase
          .from('registrations')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        const backendData = data.filter(r => r.admin_note);
        const frontendData = data.filter(r => !r.admin_note);

        let message = 'ğŸ“Š è³‡æ–™åŒæ­¥é©—è­‰çµæœ\n\n';
        message += 'â”€'.repeat(80) + '\n';
        message += `ç¸½ç­†æ•¸: ${data.length}\n`;
        message += `å¾Œå°æäº¤: ${backendData.length} ç­†\n`;
        message += `å‰ç«¯å ±å: ${frontendData.length} ç­†\n`;
        message += 'â”€'.repeat(80) + '\n\n';

        message += 'âœ… é©—è­‰é …ç›®:\n';
        message += `  [${data.length > 0 ? 'âœ“' : 'âœ—'}] Supabase è³‡æ–™åº«æœ‰è³‡æ–™\n`;
        message += `  [${backendData.length > 0 ? 'âœ“' : 'âœ—'}] å¾Œå°æäº¤çš„è³‡æ–™å­˜åœ¨\n`;
        message += `  [${frontendData.length > 0 ? 'âœ“' : 'âœ—'}] å‰ç«¯å ±åçš„è³‡æ–™å­˜åœ¨\n`;
        message += `  [${data.length > 0 ? 'âœ“' : 'âœ—'}] å‰å¾Œç«¯è³‡æ–™éƒ½åœ¨åŒä¸€å€‹è³‡æ–™åº«\n`;
        message += `  [${data.length > 0 ? 'âœ“' : 'âœ—'}] è³‡æ–™å¯ä»¥æ­£å¸¸è®€å–\n\n`;

        if (data.length > 0) {
          message += 'ğŸ“‹ æœ€æ–° 5 ç­†è³‡æ–™:\n';
          data.slice(0, 5).forEach((reg, index) => {
            const source = reg.admin_note ? 'å¾Œå°' : 'å‰ç«¯';
            message += `  ${index + 1}. [${source}] ${reg.ref_code} - ${reg.contact_name}\n`;
          });
        }

        message += '\nğŸ‰ å‰å¾Œç«¯æ•´åˆé©—è­‰: âœ… é€šéï¼';

        log('syncResult', message, 'success');
      } catch (error) {
        log('syncResult', `âŒ é©—è­‰å¤±æ•—: ${error.message}`, 'error');
      }
    }

    async function cleanupTestData() {
      if (!confirm('ç¢ºå®šè¦æ¸…ç†æ‰€æœ‰æ¸¬è©¦è³‡æ–™å—ï¼Ÿé€™å€‹æ“ä½œç„¡æ³•å¾©åŸï¼')) {
        return;
      }

      log('cleanupResult', 'ğŸ§¹ æ­£åœ¨æ¸…ç†æ¸¬è©¦è³‡æ–™...', 'info');
      
      try {
        const { data: allData } = await supabase
          .from('registrations')
          .select('ref_code')
          .or('ref_code.like.TEST-%,ref_code.like.ADMIN-%,ref_code.like.DINE-%');

        if (allData && allData.length > 0) {
          const refCodes = allData.map(r => r.ref_code);
          
          const { error } = await supabase
            .from('registrations')
            .delete()
            .in('ref_code', refCodes);

          if (error) throw error;

          log('cleanupResult', `âœ… å·²æ¸…ç† ${allData.length} ç­†æ¸¬è©¦è³‡æ–™`, 'success');
        } else {
          log('cleanupResult', 'â„¹ï¸ æ²’æœ‰æ‰¾åˆ°æ¸¬è©¦è³‡æ–™', 'info');
        }
      } catch (error) {
        log('cleanupResult', `âŒ æ¸…ç†å¤±æ•—: ${error.message}`, 'error');
      }
    }

    // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥è³‡æ–™
    window.onload = function() {
      checkExistingData();
    };
  </script>
</body>
</html>
