# 華地產鑽石春酒 專案注意事項

## 一、環境變數與金鑰

| 變數 | 用途 | 注意 |
|------|------|------|
| `VITE_SUPABASE_URL` | 前端連線 Supabase | 必填，改動後需重開 `npm run dev` |
| `VITE_SUPABASE_PUBLISHABLE_KEY` | 前端 anon key | 可公開於前端，勿用 service role |
| `SUPABASE_SERVICE_ROLE_KEY` | 腳本 / Edge Functions | **僅用於後端或本機腳本，絕不要放進前端程式碼或打包進前端** |
| `VITE_GOOGLE_APPS_SCRIPT_URL` | Google 表單／試算表整合 | 選填，未用則可留空 |

- `.env` 已在 `.gitignore`，勿把 `.env` 或真實金鑰提交到版控。
- 正式環境請在主機／CI 設定對應環境變數，不要沿用開發用 key。

---

## 二、資料庫（Supabase）

- **Schema**：所有華地產資料在 **huadrink** schema。新專案或重裝時需執行：
  - `supabase/huadrink-setup.sql`（建立表、RLS、函數）
  - `supabase/huadrink-expose-schema.sql`（讓 API 能存取 huadrink）
- **Exposed schemas**：若出現 `Invalid schema: huadrink`，到 Supabase Dashboard → SQL Editor 執行 `huadrink-expose-schema.sql`（內含 `ALTER ROLE authenticator SET pgrst.db_schemas = 'public, huadrink';`）。
- **管理員帳號**：需在 `huadrink.admins` 與 `auth.users` 對應（用腳本或 SQL 新增），否則登入後仍會被判定非管理員。

---

## 三、管理員登入與快取

- **記住登入**：勾選時用 `localStorage`（關閉分頁仍登入），不勾選用 `sessionStorage`（關閉分頁即登出）。
- **「已驗證管理員」快取**：登入成功後會把「剛驗證為管理員」寫入 `sessionStorage`（約 30 秒），進入後台時可少打一次 admins 查詢。登出會清除；逾時或重新整理後會照常再查一次 admins，不影響安全性。

---

## 四、付款與審核流程

- **已付款 → 改為尚未付款**：後台會跳出確認；確認後會一併**清除該筆的付款憑證**（`pay_proof_url`、`pay_proof_base64`、`pay_proof_last5`），無法復原。
- **付款頁「選擇報名者」**：只顯示 **尚未付款** 的內部報名；已送出憑證（審核中）的報名不會出現在下拉選單，避免重複提交。

---

## 五、上線／部署

### 之後部署怎麼做（避免又缺環境變數）

任選一種方式，**不要混用**才不會搞混：

| 方式 | 做法 | 優點 |
|------|------|------|
| **A. 本機部署（推薦）** | 改完程式 → `git push` → 在本機執行 `npm run deploy` | 用本機 `.env` 建置，不會缺變數；不用在 Cloudflare 設任何東西 |
| **B. GitHub 自動建置** | 在 Cloudflare 後台設好 `VITE_SUPABASE_URL`、`VITE_SUPABASE_PUBLISHABLE_KEY`（只設一次）→ 之後只要 `git push` 就自動部署 | 不用每次在本機跑 deploy，推完就上線 |

- 若選 **A**：不要用 Cloudflare 的「連 GitHub 自動建置」，改為用 **Direct Upload**（本機 `npm run deploy` 上傳）。若已經連了 GitHub，可到 Settings → Builds 關閉自動建置，或忽略自動建置的結果，以本機 deploy 為準。
- 若選 **B**：一定要在 Cloudflare **Environment variables** 裡加好兩個變數再 Redeploy，否則每次自動建置都會缺變數。

---

- 使用 **Vite**：環境變數須以 `VITE_` 開頭才會被打進前端，且需在**建置時**就存在（例如 CI 或主機的 env）。
- **為什麼上傳／部署後出現「缺少環境變數」或連到 placeholder.supabase.co？**  
  `.env` 沒有被提交到 Git（為了不洩漏金鑰），所以**由 Git 觸發的建置**（如 Cloudflare 連 GitHub）沒有這兩個變數。請在**部署平台**設定：
  - **Cloudflare Pages**（若專案是連 GitHub 自動建置）：
    1. 登入 https://dash.cloudflare.com → **Workers & Pages** → 點進專案 **huadrink**
    2. **Settings** → **Environment variables** → **Production**（或你使用的環境）
    3. 新增：`VITE_SUPABASE_URL` = `https://sqgrnowrcvspxhuudrqc.supabase.co`  
    4. 新增：`VITE_SUPABASE_PUBLISHABLE_KEY` = 你的 anon key（Supabase Dashboard → Project Settings → API → anon public）
    5. 儲存後到 **Deployments** → 最新一次部署右側 **⋯** → **Retry deployment**
  - 或改為本機建置再上傳：在專案根目錄執行 `npm run deploy`（會用本機 `.env` 建置後上傳，不需在 Cloudflare 設變數）。
  - **Vercel**：Project → Settings → Environment Variables → 新增後 Redeploy。
  - **Netlify**：Site → Site configuration → Environment variables → 同上。
  - **其他**：在建置前能讀到的環境變數裡加入這兩個，變數名稱必須是 `VITE_SUPABASE_URL` 與 `VITE_SUPABASE_PUBLISHABLE_KEY`。
- 本機或新 clone：在專案根目錄複製 `.env.example` 為 `.env` 並填入實際值（Supabase Dashboard → Project Settings → API 可看到 URL 與 anon key）。

---

## 六、Cloudflare Pages 自動化 CLI 部署

專案已加入 **Wrangler**，可用指令一鍵建置並上傳到 https://huadrink.pages.dev/：

1. **首次使用**（本機需有 `.env`）：
   ```bash
   npm install
   npx wrangler login
   ```
   按提示用瀏覽器登入 Cloudflare。

2. **建置 + 部署**（會讀本機 `.env` 打進建置，再上傳 `dist`）：
   ```bash
   npm run deploy
   ```
   等同執行 `npm run build` 後 `npx wrangler pages deploy dist --project-name=huadrink`。

3. **只部署已建好的 `dist`**（不重新 build）：
   ```bash
   npx wrangler pages deploy dist --project-name=huadrink
   ```

這樣用本機的 `.env` 建置，就不用在 Cloudflare 後台設環境變數；適合本機或 CI 用同一套 key 部署。

---

## 七、其他

- **GoTrueClient 單例**：前端已用單例建立 Supabase client，避免多個 GoTrueClient 警告。
- **報名／系統設定**：皆透過 `huadrink` schema 讀寫，與共同資料庫其他專案隔離。
- 若專案名稱不是 `huadrink`，請把 `package.json` 裡 `deploy` 腳本的 `--project-name=huadrink` 改成你的 Pages 專案名稱。
