# 華地產鑽石春酒 專案注意事項

## 一、環境變數與金鑰

| 變數 | 用途 | 注意 |
|------|------|------|
| `VITE_SUPABASE_URL` | 前端連線 Supabase | 必填，改動後需重開 `npm run dev` |
| `VITE_SUPABASE_PUBLISHABLE_KEY` | 前端 anon key | 可公開於前端，勿用 service role |
| `SUPABASE_SERVICE_ROLE_KEY` | 腳本 / Edge Functions | **僅用於後端或本機腳本，絕不要放進前端程式碼或打包進前端** |
| `VITE_GOOGLE_APPS_SCRIPT_URL` | Google 表單／試算表整合 | 選填，未用則可留空 |

- `.env` 已在 `.gitignore`，勿把 `.env` 或真實金鑰提交到版控。
- 正式環境請在主機／CI 設定對應環境變數，不要沿用開發用 key。

---

## 二、資料庫（Supabase）

- **Schema**：所有華地產資料在 **huadrink** schema。新專案或重裝時需執行：
  - `supabase/huadrink-setup.sql`（建立表、RLS、函數）
  - `supabase/huadrink-expose-schema.sql`（讓 API 能存取 huadrink）
- **Exposed schemas**：若出現 `Invalid schema: huadrink`，到 Supabase Dashboard → SQL Editor 執行 `huadrink-expose-schema.sql`（內含 `ALTER ROLE authenticator SET pgrst.db_schemas = 'public, huadrink';`）。
- **管理員帳號**：需在 `huadrink.admins` 與 `auth.users` 對應（用腳本或 SQL 新增），否則登入後仍會被判定非管理員。

---

## 三、管理員登入與快取

- **記住登入**：勾選時用 `localStorage`（關閉分頁仍登入），不勾選用 `sessionStorage`（關閉分頁即登出）。
- **「已驗證管理員」快取**：登入成功後會把「剛驗證為管理員」寫入 `sessionStorage`（約 30 秒），進入後台時可少打一次 admins 查詢。登出會清除；逾時或重新整理後會照常再查一次 admins，不影響安全性。

---

## 四、付款與審核流程

- **已付款 → 改為尚未付款**：後台會跳出確認；確認後會一併**清除該筆的付款憑證**（`pay_proof_url`、`pay_proof_base64`、`pay_proof_last5`），無法復原。
- **付款頁「選擇報名者」**：只顯示 **尚未付款** 的內部報名；已送出憑證（審核中）的報名不會出現在下拉選單，避免重複提交。

---

## 五、上線／部署

- 使用 **Vite**：環境變數須以 `VITE_` 開頭才會被打進前端，且需在**建置時**就存在（例如 CI 或主機的 env）。
- 部署後若前端顯示「缺少環境變數」或連不到資料，請檢查主機上的 `VITE_SUPABASE_URL`、`VITE_SUPABASE_PUBLISHABLE_KEY` 是否正確設定。

---

## 六、其他

- **GoTrueClient 單例**：前端已用單例建立 Supabase client，避免多個 GoTrueClient 警告。
- **報名／系統設定**：皆透過 `huadrink` schema 讀寫，與共同資料庫其他專案隔離。
