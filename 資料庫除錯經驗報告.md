# 華地產春酒 資料庫除錯經驗報告

> 本報告記錄 2026 年 2 月間 Supabase 資料庫連線、內部付款頁載入、管理後台登入等問題的排查過程、根因與解法，供未來參考。

---

## 一、整體狀況概覽

### 1.1 專案架構

- **前端**：React + Vite，部署於 Cloudflare Pages（huadrink.pages.dev）
- **後端**：Supabase（專案 ID：sqgrnowrcvspxhuudrqc）
- **Schema**：`huadrink`（registrations、system_settings、admins）
- **認證**：Supabase Auth + huadrink.admins 管理員白名單

### 1.2 遭遇的主要問題

| 問題 | 現象 | 影響範圍 |
|------|------|----------|
| 內部付款頁載入失敗 | 「載入報名名單中...」一直轉圈或顯示載入失敗 | 夥伴無法繳費 |
| 管理後台登入失敗 | 輸入帳密後轉圈、AbortError 或「沒有管理員權限」 | 無法進入後台 |
| 報名截止日期顯示錯誤 | 畫面固定顯示 1/31 而非後台設定值 | 使用者認知錯誤 |
| export-db 執行失敗 | `permission denied for table system_settings` | 無法匯出備份 |

---

## 二、問題細節與根因

### 2.1 內部付款頁載入不穩

**現象**：夥伴開啟內部付款頁後，「載入報名名單中...」一直轉圈，或偶爾可載入、偶爾失敗。

**根因**：

1. **無請求逾時**：Supabase 使用原生 fetch，網路不穩時請求可能長時間卡住，React Query 一直等待。
2. **查詢無索引**：`registrations` 表對 `(type, pay_status)` 的查詢做全表掃描，報名筆數一多（50+）延遲明顯。
3. **錯誤處理過嚴**：`registrations` 與 `system_settings` 任一失敗就擋住整頁，但 system_settings 有快取，不應同等對待。
4. **網路與區域**：Supabase 可能在美西，台灣用戶延遲較高；Free tier 閒置後冷啟動較慢。

**解法**：

- 為 `usePaymentEligibleRegistrations` 加上 15 秒逾時（`Promise.race` + `setTimeout`）。
- 建立 `idx_registrations_type_pay_status` 與 `idx_registrations_created_at_desc` 索引。
- 漸進式載入：匯款帳號區塊立即顯示，報名名單區塊單獨載入；8 秒未完成顯示「重試」按鈕。
- `system_settings` 失敗時使用 localStorage 快取或 fallback，不再擋住整頁。
- React Query 設定 `retry: 2`、指數退避。

### 2.2 管理後台登入失敗

**現象**：輸入 123@admin.com / 123456 後轉圈、或出現 `AbortError: signal is aborted without reason`，或顯示「此帳號未列入管理員名單」。

**根因**：

1. **AbortError**：React Strict Mode 在開發時會 mount/unmount 兩次，導致 fetch 被 abort；登入流程的 admins 查詢因此被取消。
2. **AuthProvider isLoading 卡住**：`INITIAL_SESSION` 事件若 session 為 null，未呼叫 `setLoadingFalse()`，導致 `isLoading` 一直為 true，畫面卡在載入。
3. **密碼未同步**：若曾改過密碼或帳號重建，可能與 admins 表或 auth.users 不一致。
4. **admins 查詢逾時**：12 秒內未完成會回傳逾時，導致登入失敗。

**解法**：

- 偵測 `AbortError`，顯示「連線被中斷，請再試一次」並執行 signOut 以利重試。
- 修正 useAuth：`INITIAL_SESSION` 且 session 為 null 時呼叫 `setLoadingFalse()`。
- setup-admin 腳本在帳號已存在時，一併重設密碼並 upsert 到 admins。
- 登入流程的 admins 查詢加上 12 秒逾時。

### 2.3 報名截止日期顯示錯誤

**現象**：後台已設定 deadline，前端仍顯示 1 月 31 日。

**根因**：

- `EVENT_INFO.deadline` 等常數為硬編碼。
- 部分元件用 localStorage 快取舊值，未從 `useSystemSettings` 讀取。

**解法**：

- 所有顯示 deadline 的元件改為從 `useSystemSettings` 取得，或使用共用 `formatDeadlineDisplay`。
- 更新 constants.ts 的 fallback 值。

### 2.4 export-db 執行失敗

**現象**：執行 `npm run export-db` 時出現 `permission denied for table system_settings`。

**根因**：

- `service_role` 對 `huadrink.system_settings` 沒有 SELECT 權限。
- `GRANT ALL ON ALL TABLES IN SCHEMA huadrink TO service_role` 可能未執行，或執行時表尚未建立。

**解法**：

- 在 Supabase SQL Editor 執行：
  ```sql
  GRANT ALL ON huadrink.registrations TO service_role;
  GRANT ALL ON huadrink.system_settings TO service_role;
  GRANT ALL ON huadrink.admins TO service_role;
  ```
- 新增 migration `20260204140000_service_role_grants.sql` 並更新 huadrink-expose-schema.sql。

---

## 三、資料庫設定 checklist

### 3.1 必備索引

| 索引名稱 | 用途 | SQL |
|----------|------|-----|
| idx_registrations_type_pay_status | 內部付款頁查詢 | `ON huadrink.registrations (type, pay_status)` |
| idx_registrations_created_at_desc | 管理後台列表排序 | `ON huadrink.registrations (created_at DESC)` |

執行檔：`supabase/add_registrations_index.sql` 或 `supabase/migrations/20260204100000_index_registrations_type_pay_status.sql`

### 3.2 Schema 與權限

- **pgrst.db_schemas**：authenticator 角色需包含 `public, huadrink`
- **Exposed schemas**：Supabase Dashboard → Project Settings → API
- **service_role**：需對 registrations、system_settings、admins 有 ALL 權限（供 export-db、import 等腳本使用）

### 3.3 RLS 政策

- registrations：`huadrink_Anyone can view`（SELECT 開放）
- system_settings：`huadrink_Anyone can view`（SELECT 開放）
- admins：`user_id = auth.uid()`（僅登入且為管理員可 SELECT）

---

## 四、驗證腳本與指令

| 指令 | 用途 |
|------|------|
| `npm run diagnose-supabase` | 檢查 anon 連線、system_settings、registrations 查詢 |
| `npm run check-all-env` | 環境變數檢查 + diagnose + setup-admin + export-db + create-bucket |
| `npm run verify-login-payment` | 管理登錄與內部付款報名名單讀取驗證 |
| `npm run setup-admin` | 建立或重設管理員（含密碼更新） |

---

## 五、環境變數

| 變數 | 必填 | 用途 |
|------|------|------|
| VITE_SUPABASE_URL | ✓ | 前端與腳本連線 Supabase |
| VITE_SUPABASE_PUBLISHABLE_KEY | ✓ | 前端 anon key |
| SUPABASE_SERVICE_ROLE_KEY | ✓ | setup-admin、export-db、import、create-bucket |
| ADMIN_EMAIL / ADMIN_PASSWORD | 選填 | setup-admin 非互動執行 |
| VITE_GOOGLE_APPS_SCRIPT_URL | 選填 | Google 表單整合 |

**生產環境**：Cloudflare Pages 需設定 VITE_SUPABASE_URL、VITE_SUPABASE_PUBLISHABLE_KEY，並重新建置。

---

## 六、除錯流程建議

1. **內部付款載入失敗**  
   - 執行 `npm run diagnose-supabase` 確認本機連線  
   - 請用戶開 F12 → Network，查看 registrations 請求狀態  
   - 確認 Cloudflare Pages 環境變數、索引是否已建立  

2. **管理登錄失敗**  
   - 執行 `npm run setup-admin` 重設密碼  
   - 執行 `npm run verify-login-payment` 驗證流程  
   - 檢查 Console 是否出現 AbortError（開發模式常見）  

3. **export-db 失敗**  
   - 檢查 service_role 對 huadrink 各表的 GRANT  
   - 執行 `supabase/migrations/20260204140000_service_role_grants.sql`  

---

## 七、經驗教訓

1. **索引**：常用 WHERE、ORDER BY 條件務必建立索引，否則資料量一多會明顯變慢。
2. **逾時**：對外請求應加上逾時，避免無限轉圈。
3. **錯誤隔離**：非關鍵資料（如 system_settings 快取）失敗時，不應擋住整個頁面。
4. **service_role 權限**：腳本用的 service_role 需明確 GRANT 各表，ALL TABLES 不一定覆蓋到。
5. **React Strict Mode**：開發時會觸發 AbortError，需妥善處理並給使用者明確提示。
6. **自動化驗證**：建立 check-all-env、verify-login-payment 等腳本，可快速排除環境與權限問題。

---

## 八、相關文件

- `CONNECTION_SETUP.md`：前後端連線設定
- `DATABASE_NOTES.md`：資料庫索引與設定
- `PAYMENT_CONNECTION_FLOW.md`：內部付款頁連線流程
- `PAYMENT_LOADING_ANALYSIS.md`：載入不穩根因分析
- `內部付款載入狀況報告.md`：夥伴端載入失敗排查
