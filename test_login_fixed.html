<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¸¬è©¦ç™»å…¥ä¿®å¾©</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 700px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #28a745;
      padding-bottom: 10px;
    }
    .info-box {
      background: #d4edda;
      border-left: 4px solid #28a745;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
    }
    button {
      background: #28a745;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
      width: 100%;
    }
    button:hover {
      background: #218838;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 6px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
    }
    .success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    .link-btn {
      display: inline-block;
      margin: 10px 5px;
      padding: 10px 20px;
      background: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 6px;
    }
    .link-btn:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>âœ… æ¸¬è©¦ç™»å…¥ä¿®å¾©</h1>
    
    <div class="info-box">
      <strong>ç®¡ç†å“¡å¸³è™Ÿè³‡è¨Šï¼š</strong><br>
      Email: <code>123@admin.com</code><br>
      å¯†ç¢¼: <code>123456</code>
    </div>

    <div style="margin: 20px 0;">
      <a href="http://localhost:5174/admin/login" target="_blank" class="link-btn">ğŸŒ æ‰“é–‹ç™»å…¥é é¢</a>
      <a href="http://localhost:5174/admin" target="_blank" class="link-btn">ğŸ”§ æ‰“é–‹å¾Œå°ç®¡ç†</a>
    </div>

    <button onclick="testLogin()">æ¸¬è©¦ç™»å…¥åŠŸèƒ½</button>
    <button onclick="checkRLSPolicy()">æª¢æŸ¥ RLS ç­–ç•¥</button>
    <button onclick="verifyAdminAccount()">é©—è­‰ç®¡ç†å“¡å¸³è™Ÿ</button>
    
    <div id="result"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://kwxlxjfcdghpguypadvi.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3eGx4amZjZGdocGd1eXBhZHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3ODk5NTMsImV4cCI6MjA4NDM2NTk1M30.0KJIXhxlPOx-5tWQyX12DMNXcWCLc2NmMCyoJY4y024';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function log(message, type = 'info') {
      const result = document.getElementById('result');
      result.className = type;
      result.textContent = message;
      console.log(message);
    }

    async function testLogin() {
      log('ğŸ” æ­£åœ¨æ¸¬è©¦ç™»å…¥åŠŸèƒ½...', 'info');
      
      try {
        // å…ˆç™»å‡ºï¼ˆå¦‚æœå·²ç™»å…¥ï¼‰
        await supabase.auth.signOut();

        // æ¸¬è©¦ç™»å…¥
        const { data, error } = await supabase.auth.signInWithPassword({
          email: '123@admin.com',
          password: '123456',
        });

        if (error) {
          log(`âŒ ç™»å…¥å¤±æ•—: ${error.message}\n\nå¯èƒ½çš„åŸå› ï¼š\n1. å¯†ç¢¼å°šæœªä¿®æ”¹ç‚º 123456\n2. ç”¨æˆ¶ä¸å­˜åœ¨\n3. å¸³è™Ÿæœªç¢ºèª\n\nè«‹æª¢æŸ¥ Supabase Dashboard ä¸­çš„ç”¨æˆ¶è¨­ç½®`, 'error');
          return;
        }

        if (!data.user) {
          log('âŒ ç™»å…¥å¤±æ•—ï¼šæœªè¿”å›ç”¨æˆ¶è³‡æ–™', 'error');
          return;
        }

        // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡ï¼ˆé€™æ˜¯ä¹‹å‰æœƒå‡ºéŒ¯çš„åœ°æ–¹ï¼‰
        const { data: adminData, error: adminError } = await supabase
          .from('admins')
          .select('id')
          .eq('user_id', data.user.id)
          .maybeSingle();

        let message = 'âœ… ç™»å…¥æ¸¬è©¦æˆåŠŸï¼\n\n';
        message += `ğŸ“ ç”¨æˆ¶è³‡è¨Š:\n`;
        message += `   ç”¨æˆ¶ ID: ${data.user.id}\n`;
        message += `   Email: ${data.user.email}\n`;
        message += `   ç®¡ç†å“¡ç‹€æ…‹: ${adminData ? 'âœ… æ˜¯ç®¡ç†å“¡' : 'âŒ ä¸æ˜¯ç®¡ç†å“¡'}\n\n`;

        if (adminError) {
          message += `âš ï¸ æŸ¥è©¢ç®¡ç†å“¡ç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤: ${adminError.message}\n`;
          message += `é€™è¡¨ç¤º RLS ç­–ç•¥å¯èƒ½é‚„æœ‰å•é¡Œ\n`;
        } else if (!adminData) {
          message += `âš ï¸ ç”¨æˆ¶å·²ç™»å…¥ï¼Œä½†ä¸æ˜¯ç®¡ç†å“¡ï¼\n`;
          message += `è«‹åœ¨ Supabase SQL Editor ä¸­åŸ·è¡Œï¼š\n`;
          message += `INSERT INTO public.admins (user_id)\n`;
          message += `SELECT id FROM auth.users WHERE email = '123@admin.com'\n`;
          message += `ON CONFLICT (user_id) DO NOTHING;\n`;
        } else {
          message += `ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼\n`;
          message += `âœ… ç™»å…¥åŠŸèƒ½æ­£å¸¸\n`;
          message += `âœ… RLS ç­–ç•¥å·²ä¿®å¾©\n`;
          message += `âœ… ç®¡ç†å“¡æ¬Šé™æ­£å¸¸\n`;
          message += `\nğŸ’¡ ç¾åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨å¾Œå°ç®¡ç†åŠŸèƒ½äº†ï¼\n`;
          message += `è¨ªå•ï¼šhttp://localhost:5174/admin`;
        }

        log(message, adminData && !adminError ? 'success' : 'error');

        // ç™»å‡º
        await supabase.auth.signOut();
      } catch (error) {
        log(`âŒ éŒ¯èª¤: ${error.message}`, 'error');
      }
    }

    async function checkRLSPolicy() {
      log('ğŸ” æ­£åœ¨æª¢æŸ¥ RLS ç­–ç•¥...', 'info');
      
      try {
        // å˜—è©¦æŸ¥è©¢ admins è¡¨ï¼ˆä¸ç™»å…¥çš„æƒ…æ³ä¸‹æ‡‰è©²æœƒå¤±æ•—ï¼Œä½†ä¸æœƒæ˜¯ 500 éŒ¯èª¤ï¼‰
        const { data, error } = await supabase
          .from('admins')
          .select('*')
          .limit(1);

        let message = 'ğŸ“Š RLS ç­–ç•¥æª¢æŸ¥çµæœ\n\n';

        if (error) {
          if (error.code === 'PGRST116' || error.message.includes('permission denied')) {
            message += 'âœ… RLS ç­–ç•¥æ­£å¸¸é‹ä½œï¼ˆæœªç™»å…¥æ™‚ç„¡æ³•æŸ¥è©¢ï¼Œé€™æ˜¯é æœŸè¡Œç‚ºï¼‰\n';
            message += `   éŒ¯èª¤é¡å‹: ${error.code || 'Permission Denied'}\n`;
            message += `   é€™ä¸æ˜¯ 500 éŒ¯èª¤ï¼Œè¡¨ç¤º RLS ç­–ç•¥å·²æ­£ç¢ºè¨­ç½®\n\n`;
            message += 'ğŸ’¡ ç¾åœ¨è«‹ç™»å…¥å¾Œå†æ¸¬è©¦ï¼Œæ‡‰è©²ä¸æœƒå‡ºç¾ 500 éŒ¯èª¤äº†\n';
          } else if (error.message.includes('500') || error.code === '500') {
            message += 'âŒ ä»ç„¶å‡ºç¾ 500 éŒ¯èª¤ï¼\n';
            message += `   éŒ¯èª¤è¨Šæ¯: ${error.message}\n\n`;
            message += 'è«‹ç¢ºèªï¼š\n';
            message += '1. æ˜¯å¦å·²åŸ·è¡Œ fix_admins_rls.sql ä¸­çš„ SQL\n';
            message += '2. æ˜¯å¦å·²åˆªé™¤èˆŠçš„ RLS ç­–ç•¥\n';
            message += '3. æ˜¯å¦å·²å‰µå»ºæ–°çš„ RLS ç­–ç•¥\n';
          } else {
            message += `â„¹ï¸ æŸ¥è©¢çµæœ: ${error.message}\n`;
            message += `   éŒ¯èª¤ä»£ç¢¼: ${error.code || 'N/A'}\n`;
          }
        } else {
          message += 'âš ï¸ æœªç™»å…¥æ™‚å¯ä»¥æŸ¥è©¢ admins è¡¨\n';
          message += 'é€™å¯èƒ½è¡¨ç¤º RLS ç­–ç•¥è¨­ç½®æœ‰å•é¡Œ\n';
        }

        log(message, error && !error.message.includes('500') ? 'success' : 'info');
      } catch (error) {
        log(`âŒ éŒ¯èª¤: ${error.message}`, 'error');
      }
    }

    async function verifyAdminAccount() {
      log('ğŸ” æ­£åœ¨é©—è­‰ç®¡ç†å“¡å¸³è™Ÿ...', 'info');
      
      try {
        // å…ˆç™»å…¥
        const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
          email: '123@admin.com',
          password: '123456',
        });

        if (authError) {
          log(`âŒ ç„¡æ³•ç™»å…¥: ${authError.message}\n\nè«‹ç¢ºèªï¼š\n1. ç”¨æˆ¶æ˜¯å¦å·²å‰µå»º\n2. å¯†ç¢¼æ˜¯å¦ç‚º 123456\n3. ç”¨æˆ¶æ˜¯å¦å·²ç¢ºèª`, 'error');
          return;
        }

        // æŸ¥è©¢ç®¡ç†å“¡è¨˜éŒ„
        const { data: adminData, error: adminError } = await supabase
          .from('admins')
          .select('*')
          .eq('user_id', authData.user.id)
          .maybeSingle();

        let message = 'ğŸ“Š ç®¡ç†å“¡å¸³è™Ÿé©—è­‰çµæœ\n\n';
        message += `âœ… ç”¨æˆ¶ç™»å…¥: æˆåŠŸ\n`;
        message += `   ç”¨æˆ¶ ID: ${authData.user.id}\n`;
        message += `   Email: ${authData.user.email}\n\n`;

        if (adminError) {
          message += `âŒ æŸ¥è©¢ç®¡ç†å“¡è¨˜éŒ„å¤±æ•—: ${adminError.message}\n`;
          if (adminError.message.includes('500')) {
            message += `\nâš ï¸ ä»ç„¶å‡ºç¾ 500 éŒ¯èª¤ï¼\n`;
            message += `è«‹ç¢ºèª RLS ç­–ç•¥æ˜¯å¦å·²æ­£ç¢ºä¿®å¾©\n`;
          }
        } else if (adminData) {
          message += `âœ… ç®¡ç†å“¡è¨˜éŒ„: å­˜åœ¨\n`;
          message += `   ç®¡ç†å“¡ ID: ${adminData.id}\n`;
          message += `   å‰µå»ºæ™‚é–“: ${new Date(adminData.created_at).toLocaleString('zh-TW')}\n\n`;
          message += `ğŸ‰ ç®¡ç†å“¡å¸³è™Ÿè¨­ç½®å®Œæ•´ï¼\n`;
          message += `å¯ä»¥æ­£å¸¸ä½¿ç”¨å¾Œå°ç®¡ç†åŠŸèƒ½äº†ï¼\n`;
        } else {
          message += `âš ï¸ ç®¡ç†å“¡è¨˜éŒ„: ä¸å­˜åœ¨\n`;
          message += `è«‹åœ¨ Supabase SQL Editor ä¸­åŸ·è¡Œï¼š\n`;
          message += `INSERT INTO public.admins (user_id)\n`;
          message += `SELECT id FROM auth.users WHERE email = '123@admin.com'\n`;
          message += `ON CONFLICT (user_id) DO NOTHING;\n`;
        }

        log(message, adminData && !adminError ? 'success' : 'error');

        // ç™»å‡º
        await supabase.auth.signOut();
      } catch (error) {
        log(`âŒ éŒ¯èª¤: ${error.message}`, 'error');
      }
    }
  </script>
</body>
</html>
