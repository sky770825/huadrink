# 登入狀態與刷新問題：可能原因總覽

## 本次解決重點（實測結論）

經由診斷日誌鎖定並修正後，**刷新後自動登出／無法進入後台**的問題已排除。以下為本次重點整理，供日後維護與其他專案參考。

### 問題現象

- 開啟後台一段時間後**重整頁面**，會被導向登入頁（看似自動登出）。
- 或畫面一直「正在驗證登入狀態…」、轉圈、讀不到資料。

### 根因（依診斷日誌確認）

1. **getSession() 逾時後誤覆寫登入狀態**  
   `getSession()` 在網路／Supabase 慢時可能超過 5 秒才回傳，但程式用 5 秒逾時做 `Promise.race`，逾時時會執行 `setUser(null)`，**把已經由 `onAuthStateChange(SIGNED_IN)` 設好的 user 蓋掉**，導致被導向登入頁。
2. **onAuthStateChange(SIGNED_IN) 的 admins 查詢沒有逾時**  
   重整時 Supabase 常先觸發 `SIGNED_IN`（約 0.1～6 秒），程式會去查 `huadrink.admins`。若該查詢卡住不回傳，就永遠不會設定 `isAdmin`、也不會結束 loading，直到 15 秒 fallback 觸發時 `isAdmin` 仍為 false → 被導向登入頁。

### 具體修正（已套用）

| 項目 | 修正前 | 修正後 |
|------|--------|--------|
| getSession 逾時時 | `setUser(null)`，導向登入 | **僅 `setLoadingFalse()`，不改動 user**，保留 onAuthStateChange 已設的登入狀態 |
| getSession / loading 逾時時間 | 5 秒 | **15 秒**（實測慢速時 getSession 可達約 12 秒） |
| admins 查詢逾時（resolveAdmin） | 8 秒 | **15 秒**，與 session 一致 |
| onAuthStateChange(SIGNED_IN) 的 admins 查詢 | 無逾時，可能卡住 | **15 秒 Promise.race 逾時**，逾時則設 isAdmin=false 並結束 loading |
| RequireAdmin 顯示「載入逾時」 | 8 秒 | **18 秒**，留緩衝給 15 秒流程跑完 |

### 診斷方式（可重複使用）

- **開啟**：登入頁點「開啟登入診斷並重整」，或 Console 執行 `localStorage.setItem('huadrink_auth_debug', 'true')` 後重整。
- **查看**：F12 → Console，篩選 `[Auth`，依時間序看 getSession／onAuthStateChange／逾時／RequireAdmin 導向。
- **關閉**：Console 執行 `localStorage.removeItem('huadrink_auth_debug')`。

### 其他專案可複用重點

- 逾時時**不要用「無 session」覆寫已由 onAuthStateChange 設好的 user**；逾時只結束 loading。
- 所有依賴遠端（getSession、admins）的流程都要**設逾時**，避免卡住導致 isAdmin／user 永遠不更新。
- 逾時時間要**大於實測慢速回傳時間**（例如 12 秒才回傳就至少 15 秒逾時）。
- 用 **authDebug + authLog** 在每個環節打點，出問題時一次看日誌即可鎖定環節。

---

## 現象摘要

- 開啟網頁一段時間後，**刷新頁面**會自動跳出登入狀態（被導向登入頁）。
- 接著出現：**讀取不到會員／報名資料**，或畫面**一直轉圈、卡住**。

以下列出可能原因，依「Session／Auth」「前端邏輯」「網路／後端」分類，方便逐項排查與修正。

---

## 一、Session／Auth 相關

### 1. getSession() 逾時被當成「未登入」（已修正：逾時不再覆寫 user，且改為 15 秒）

- **位置**：`src/hooks/useAuth.tsx`，`SESSION_WAIT_MS = 15_000`，`tryGetSession()` 用 `Promise.race(getSession, timeout)`。
- **原行為**：逾時時會 `setUser(null)`，把 onAuthStateChange 已設的登入狀態蓋掉。
- **修正後**：逾時時**僅呼叫 `setLoadingFalse()`**，不改動 user；逾時時間改為 15 秒以配合慢速／冷啟動。
- **是否可能**：已排除誤判；若 getSession 常超過 15 秒可再調大。

### 2. JWT access token 過期，且 refresh 失敗或未執行

- **行為**：Supabase 的 access token 有有效期（預設約 1 小時）。若分頁長時間開著、背景執行，`autoRefreshToken` 可能沒在過期前成功刷新；或刷新時網路失敗、refresh token 也過期。
- **刷新頁面時**：`getSession()` 會從 storage 讀出 session，若發現 token 過期會嘗試 refresh；若 refresh 失敗，Supabase 可能清掉 session → 回傳 `null`。
- **結果**：真正「登出」，不是前端誤判。
- **是否可能**：**是**。尤其是開著分頁很久沒操作再刷新。

### 3. 「記住登入」未勾選時使用 sessionStorage

- **位置**：`src/integrations/supabase/client.ts`，`getAuthStorage()` 當 `REMEMBER_KEY === 'false'` 時用 `sessionStorage`。
- **行為**：session 只存在該分頁的 sessionStorage。若使用者「開新分頁」再打同一個後台網址，新分頁的 sessionStorage 是空的 → 沒有 session。
- **結果**：在新分頁或部分情境下會像沒登入。但「同分頁刷新」理論上 sessionStorage 還在，除非被上述 1 或 2 清掉。
- **是否可能**：**部分**。主要影響新分頁；同分頁刷新較可能是 1 或 2。

### 4. onAuthStateChange 與 tryGetSession 競態

- **行為**：重整時同時有 (1) `tryGetSession()` (2) `onAuthStateChange(INITIAL_SESSION)`。若逾時先觸發，會先設 `user = null`、`isLoading = false`，`RequireAdmin` 立刻導向登入頁；之後即使 `INITIAL_SESSION` 帶回正確 session，使用者已被轉到登入頁。
- **結果**：與原因 1 類似，都是「逾時先贏」導致誤判未登入。
- **是否可能**：**是**。

### 5. admins 查詢逾時導致 isAdmin 被設為 false

- **位置**：`useAuth.tsx` 的 `resolveAdmin()`，`ADMIN_CHECK_TIMEOUT_MS = 8000`。
- **行為**：有 session 但查 `huadrink.admins` 逾時時，會把 `isAdmin` 設為 `false`。
- **結果**：`RequireAdmin` 看到 `user` 有值但 `!isAdmin` → 仍會導向登入頁，看起來像「被登出」。
- **是否可能**：**是**。若 Supabase 或網路慢，admins 查詢容易逾時。

---

## 二、前端邏輯／載入流程

### 6. 8 秒載入逾時只顯示「前往登入」，未再等 session

- **位置**：`App.tsx` 的 `RequireAdmin`，`LOADING_FALLBACK_MS = 8000`。
- **行為**：`isLoading` 一直為 `true` 時（例如 getSession / admins 都慢），8 秒後只顯示「載入逾時、前往登入」，沒有再給 session 一點時間完成。
- **結果**：使用者以為已「逾時」而點進登入頁，實際上 session 可能稍後才回來。
- **是否可能**：**是**。會加重「卡住 → 被當成未登入」的體感。

### 7. 報名／內部成員查詢逾時或失敗，導致畫面一直轉圈

- **位置**：`useRegistrations`、`usePaymentEligibleRegistrations`、內部成員的 query 等，各有 15 秒或自訂逾時。
- **行為**：若 Supabase 或網路不穩，這些查詢可能逾時、失敗或一直 pending。Dashboard 依賴這些資料，若 query 不結束或反覆 retry，畫面會一直 loading。
- **結果**：「讀取不到會員資料」或「轉圈、卡住」，不一定與 session 遺失同時發生，但常一起出現（例如同一時間網路或 Supabase 變慢）。
- **是否可能**：**是**。

### 8. 登入後 prefetch 逾時（6 秒）仍進後台，但資料尚未載入

- **位置**：`Login.tsx`，`Promise.race([Promise.all(prefetch...), timeout 6s])`。
- **行為**：登入成功後預載報名與內部成員，最多等 6 秒就進 `/admin`。若 6 秒內沒載完，進後台時 query 才開始或重跑，使用者會看到一段時間的 loading。
- **結果**：較少直接造成「跳出登入」，但會造成「進後台後還在轉圈、資料很慢才出來」的體感；若再疊加刷新，容易和「刷新後卡住」混在一起。
- **是否可能**：**有**。主要影響體感，不是主因。

---

## 三、網路／Supabase／環境

### 9. 網路不穩或暫時斷線

- **行為**：刷新時若剛好網路抖動、斷線，`getSession()`、`refreshSession()` 或 admins／registrations 查詢可能失敗或逾時。
- **結果**：session 被清掉或前端逾時誤判未登入；或資料查不到、一直轉圈。
- **是否可能**：**是**。尤其在行動網路或 Wi‑Fi 不穩時。

### 10. Supabase 專案冷啟動或限流

- **行為**：免費方案或長時間無請求後，Supabase 可能冷啟動或觸發 rate limit，導致首幾次請求變慢或失敗。
- **結果**：與 1、2、5、7 類似：getSession／refresh／admins／registrations 變慢或失敗，導致「登出」或「卡住」。
- **是否可能**：**是**。

### 11. CORS 或 API 金鑰／專案設定錯誤

- **行為**：若環境變數錯誤、專案被停用、或 CORS 設定不允許前端網址，瀏覽器可能擋掉請求或拿到非 200 回應。
- **結果**：前端拿不到 session 或資料，錯誤處理後可能變成「未登入」或一直重試、轉圈。
- **是否可能**：**有**。通常會伴隨 Console 錯誤，較易從開發者工具發現。

### 12. 瀏覽器擴充功能或隱私設定清除 storage

- **行為**：部分擴充功能或「清除瀏覽資料」會清 localStorage／sessionStorage；或無痕／嚴格隱私模式關閉分頁後 storage 被清掉。
- **結果**：下次開啟或刷新時沒有 session → 一定未登入。
- **是否可能**：**有**。較難重現，但若使用者有清資料習慣或使用無痕，會發生。

---

## 四、總結對照表

| # | 可能原因 | 較可能造成「刷新後跳出登入」 | 較可能造成「讀不到資料／轉圈」 |
|---|----------|------------------------------|--------------------------------|
| 1 | getSession 逾時（5s）誤判未登入 | ✅ | - |
| 2 | JWT 過期且 refresh 失敗 | ✅ | - |
| 3 | 未勾選記住登入 + sessionStorage | 部分（如新分頁） | - |
| 4 | onAuthStateChange 與 tryGetSession 競態 | ✅ | - |
| 5 | admins 查詢逾時，isAdmin 被設 false | ✅ | - |
| 6 | RequireAdmin 載入逾時 8s 就顯示前往登入 | ✅ | - |
| 7 | 報名／成員查詢逾時或失敗 | - | ✅ |
| 8 | 登入後 prefetch 未完成就進後台 | - | ✅（體感） |
| 9 | 網路不穩／暫時斷線 | ✅ | ✅ |
| 10 | Supabase 冷啟動／限流 | ✅ | ✅ |
| 11 | CORS／金鑰／專案設定錯誤 | ✅ | ✅ |
| 12 | 瀏覽器清除 storage／無痕 | ✅ | - |

---

## 五、建議排查順序

1. **先確認是否為「逾時誤判」**：在 `useAuth` 暫時把 `SESSION_WAIT_MS` 調大（例如 10 秒）、`ADMIN_CHECK_TIMEOUT_MS` 調大，再重現「開一段時間 → 刷新」。若現象消失或變少，可鎖定原因 1、4、5。
2. **看 Console / Network**：刷新當下是否有 getSession、refreshSession、admins 或 registrations 請求失敗、逾時、4xx/5xx。
3. **確認「記住登入」**：若未勾選，改用勾選後測試同分頁刷新，排除 sessionStorage 情境（原因 3）。
4. **重現「開很久再刷新」**：若多發生在開著分頁 30 分鐘～1 小時以上再刷新，偏向 JWT 過期與 refresh（原因 2、10）。
5. **比對有無錯誤**：若有 CORS、401、403 或 Supabase 錯誤訊息，再對照原因 11。

之後可依上述結果，針對最可能的一兩項做修正（例如放寬逾時、改為「逾時時再等一次 session」、或改善 refresh 策略），再重測。

---

## 六、逐一排查步驟（使用診斷日誌）

專案已內建**可開關的 Auth 診斷日誌**，可精準看出是哪一個環節出問題。

### 6.1 開啟診斷（二選一）

**方式 A（推薦，免貼程式碼）**

1. 打開 **登入頁**（`/admin/login`）。本機開發時頁面下方會出現「排查『刷新後自動登出』」區塊。
2. 點 **「開啟登入診斷並重整」**。頁面會自動重整並進入 auth 流程。
3. 按 **F12** → **Console**，篩選 `[Auth` 查看日誌。
4. 若要重現「開一段時間後刷新」：登入後台後，等幾分鐘再手動重整一次，再查看 Console。

**方式 B（手動在 Console 設定）**

1. 在後台頁面（或登入頁）按 **F12** → **Console**。
2. 輸入並執行：`localStorage.setItem('huadrink_auth_debug', 'true')`
3. **重整頁面**（F5 或 Ctrl+R），並盡量重現「開一段時間後刷新」的情境。

### 6.2 查看日誌

在 Console 中篩選 **`[Auth`**，會看到一連串帶時間戳的訊息，例如：

- `[Auth 0.00s] AuthProvider mounted (start)`
- `[Auth 0.01s] tryGetSession start`
- `[Auth 0.02s] onAuthStateChange {"event":"INITIAL_SESSION", ...}`
- `[Auth 0.15s] getSession() resolved {"elapsed":142,"hasSession":true}`
- …依序到 `resolveAdmin`、`admins query done` 或逾時訊息。

### 6.3 依日誌判斷出問題的環節

| 若看到以下日誌 | 代表出問題的環節 | 對應可能原因 |
|----------------|------------------|--------------|
| `SESSION_WAIT timeout (5s) 先觸發` | getSession 被 5 秒逾時先當成「無 session」 | **原因 1** |
| `getSession 晚於逾時，可能原因 1/4` | getSession 其實有回傳，但逾時先觸發已導向登入 | **原因 1、4** |
| `ADMIN_CHECK_TIMEOUT fired` | admins 查詢逾時，isAdmin 被設為 false | **原因 5** |
| `RequireAdmin: 8s 載入逾時顯示「前往登入」` | 使用者看到逾時提示才去登入頁 | **原因 6** |
| `RequireAdmin: 導向登入頁` + `hasUser: false` | 前端已認定無使用者（可能是 1、2、4） | **原因 1、2、4** |
| `RequireAdmin: 導向登入頁` + `hasUser: true, isAdmin: false` | 有 user 但非管理員（可能是 5） | **原因 5** |
| `getSession() resolved` + `hasSession: false` 且無 timeout 先觸發 | Supabase 端真的沒有 session（可能 2、3、12） | **原因 2、3、12** |
| `admins query error` | 查 admins 時發生錯誤（網路或 RLS） | **原因 9、10、11** |

### 6.4 關閉診斷

排查完成後，在 Console 執行：

```js
localStorage.removeItem('huadrink_auth_debug')
```

重整後即不再輸出 `[Auth ...]` 日誌。

### 6.5 其他專案如何套用

- 診斷邏輯在 **`src/lib/authDebug.ts`**（`authLog`）與 **`src/hooks/useAuth.tsx`**（各環節呼叫 `authLog`）。
- 其他專案可複製 `authDebug.ts`，並在 auth 流程中相同時機點（mount、tryGetSession、getSession 結果、逾時、onAuthStateChange、resolveAdmin、admins 查詢結果／逾時、RequireAdmin 導向）加入 `authLog`，即可用相同方式排查。

---

## 七、仍無法進入時：其他可能原因與對應日誌

若已修正「getSession 逾時覆蓋 user」與「admins 逾時過短」，仍不時無法進入後台，可依下表對照日誌與可能性：

| 現象 | 可能原因 | 日誌／檢查方式 |
|------|----------|----------------|
| 有 user 但仍被導向登入頁 | **原因 5**：admins 查詢逾時或失敗，`isAdmin` 被設為 false | 看是否出現 `ADMIN_CHECK_TIMEOUT fired` 或 `admins query error`；已將 admins 逾時改為 15 秒與 getSession 一致 |
| 畫面一直「正在驗證登入狀態…」 | **原因 5／7**：admins 或後續查詢卡住未回傳；或從未呼叫 `setLoadingFalse` | 看是否有 `resolveAdmin: querying admins` 但一直沒有 `admins query done` 或 `ADMIN_CHECK_TIMEOUT fired`；或 Network 有請求 pending |
| 進入後台但列表一直轉圈 | **原因 7**：報名／內部成員查詢逾時或失敗 | 看 Network 中 `registrations` 或 `internal_members` 是否失敗、逾時；Console 是否有相關錯誤 |
| 重整後偶爾可進、偶爾不行 | **原因 9／10**：網路不穩或 Supabase 冷啟動，getSession／admins 有時慢有時快 | 開診斷多重整幾次，對照每次日誌差異（逾時 vs 正常回傳） |
| 換裝置或無痕就進不了 | **原因 3／12**：未勾選「記住登入」用 sessionStorage，或無痕關閉後清掉 | 確認登入時有勾選「記住登入」；無痕／清資料後需重新登入 |
| 開很久（如 1 小時）再重整才失敗 | **原因 2**：JWT 過期且 refresh 失敗，session 被清掉 | 日誌會是 `getSession() resolved` 且 `hasSession: false`（非逾時）；可考慮縮短 token 有效期或確保背景 refresh |
| 只有某環境（如正式網域）進不了 | **原因 11**：CORS、金鑰錯誤或 Supabase 專案未允許該網域 | 看 Console 是否有 CORS、401、403；Supabase Dashboard → Authentication → URL Configuration 是否包含該網域 |

**建議**：再次開啟診斷（登入頁「開啟登入診斷並重整」），重整後把整段 `[Auth ...]` 日誌複製下來。對照上表與「6.3 依日誌判斷出問題的環節」，即可鎖定是哪一環節。
