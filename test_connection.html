<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¸¬è©¦ Supabase é€£æ¥</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 6px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 14px;
    }
    .success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    .test-item {
      margin: 10px 0;
      padding: 10px;
      border-left: 3px solid #007bff;
      background: #f8f9fa;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Supabase é€£æ¥æ¸¬è©¦</h1>
    <p>æ­¤å·¥å…·æœƒæ¸¬è©¦ Supabase è³‡æ–™åº«é€£æ¥å’ŒåŸºæœ¬åŠŸèƒ½</p>
    
    <button onclick="testConnection()">é–‹å§‹æ¸¬è©¦</button>
    
    <div id="result"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://kwxlxjfcdghpguypadvi.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3eGx4amZjZGdocGd1eXBhZHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3ODk5NTMsImV4cCI6MjA4NDM2NTk1M30.0KJIXhxlPOx-5tWQyX12DMNXcWCLc2NmMCyoJY4y024';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function log(message, type = 'info') {
      const result = document.getElementById('result');
      result.className = type;
      result.textContent = message;
      console.log(message);
    }

    async function testConnection() {
      let logMessage = 'ğŸš€ é–‹å§‹æ¸¬è©¦ Supabase é€£æ¥...\n\n';

      try {
        // æ¸¬è©¦ 1: æª¢æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
        logMessage += 'ğŸ“Š æ¸¬è©¦ 1: æª¢æŸ¥ registrations è¡¨...\n';
        log(logMessage, 'info');

        const { data: tables, error: tableError } = await supabase
          .from('registrations')
          .select('id')
          .limit(1);

        if (tableError) {
          throw new Error(`ç„¡æ³•è¨ªå• registrations è¡¨: ${tableError.message}`);
        }

        logMessage += 'âœ… registrations è¡¨å­˜åœ¨ä¸”å¯è¨ªå•\n\n';
        log(logMessage, 'info');

        // æ¸¬è©¦ 2: æª¢æŸ¥ system_settings è¡¨
        logMessage += 'âš™ï¸ æ¸¬è©¦ 2: æª¢æŸ¥ system_settings è¡¨...\n';
        log(logMessage, 'info');

        const { data: settings, error: settingsError } = await supabase
          .from('system_settings')
          .select('*')
          .limit(10);

        if (settingsError) {
          throw new Error(`ç„¡æ³•è¨ªå• system_settings è¡¨: ${settingsError.message}`);
        }

        logMessage += `âœ… system_settings è¡¨å­˜åœ¨ï¼Œæ‰¾åˆ° ${settings?.length || 0} ç­†è¨­å®š\n`;
        if (settings && settings.length > 0) {
          settings.forEach(s => {
            logMessage += `   - ${s.key}: ${s.value}\n`;
          });
        }
        logMessage += '\n';
        log(logMessage, 'info');

        // æ¸¬è©¦ 3: æ¸¬è©¦æ’å…¥è³‡æ–™ï¼ˆæ¸¬è©¦å¯«å…¥æ¬Šé™ï¼‰
        logMessage += 'âœï¸ æ¸¬è©¦ 3: æ¸¬è©¦å¯«å…¥æ¬Šé™...\n';
        log(logMessage, 'info');

        const testRefCode = 'TEST-' + Date.now().toString().slice(-6);
        const { data: insertData, error: insertError } = await supabase
          .from('registrations')
          .insert({
            ref_code: testRefCode,
            type: 'external',
            headcount: 1,
            attendee_list: [],
            company: 'æ¸¬è©¦å…¬å¸',
            contact_name: 'æ¸¬è©¦ç”¨æˆ¶',
            phone: '0912345678',
            email: 'test@example.com',
            diet: 'normal',
            photo_consent: true,
            invoice_needed: false,
            pay_method: 'transfer',
            pay_status: 'paid',
            status: 'open',
          })
          .select()
          .single();

        if (insertError) {
          throw new Error(`ç„¡æ³•æ’å…¥è³‡æ–™: ${insertError.message}`);
        }

        logMessage += `âœ… æˆåŠŸæ’å…¥æ¸¬è©¦è³‡æ–™ï¼ˆç·¨è™Ÿ: ${testRefCode}ï¼‰\n\n`;
        log(logMessage, 'info');

        // æ¸¬è©¦ 4: æ¸¬è©¦è®€å–è³‡æ–™
        logMessage += 'ğŸ“– æ¸¬è©¦ 4: æ¸¬è©¦è®€å–è³‡æ–™...\n';
        log(logMessage, 'info');

        const { data: readData, error: readError } = await supabase
          .from('registrations')
          .select('*')
          .eq('ref_code', testRefCode)
          .single();

        if (readError) {
          throw new Error(`ç„¡æ³•è®€å–è³‡æ–™: ${readError.message}`);
        }

        logMessage += `âœ… æˆåŠŸè®€å–è³‡æ–™\n`;
        logMessage += `   è¯çµ¡äºº: ${readData.contact_name}\n`;
        logMessage += `   é›»è©±: ${readData.phone}\n`;
        logMessage += `   é¡å‹: ${readData.type}\n\n`;
        log(logMessage, 'info');

        // æ¸¬è©¦ 5: æ¸…ç†æ¸¬è©¦è³‡æ–™
        logMessage += 'ğŸ§¹ æ¸¬è©¦ 5: æ¸…ç†æ¸¬è©¦è³‡æ–™...\n';
        log(logMessage, 'info');

        const { error: deleteError } = await supabase
          .from('registrations')
          .delete()
          .eq('ref_code', testRefCode);

        if (deleteError) {
          logMessage += `âš ï¸ ç„¡æ³•åˆªé™¤æ¸¬è©¦è³‡æ–™ï¼ˆå¯å¿½ç•¥ï¼‰: ${deleteError.message}\n\n`;
        } else {
          logMessage += 'âœ… æ¸¬è©¦è³‡æ–™å·²æ¸…ç†\n\n';
        }
        log(logMessage, 'info');

        // ç¸½çµ
        logMessage += 'ğŸ“Š æ¸¬è©¦çµæœç¸½çµ:\n';
        logMessage += '  âœ… è³‡æ–™åº«é€£æ¥: æˆåŠŸ\n';
        logMessage += '  âœ… è¡¨çµæ§‹: æ­£ç¢º\n';
        logMessage += '  âœ… è®€å–æ¬Šé™: æ­£å¸¸\n';
        logMessage += '  âœ… å¯«å…¥æ¬Šé™: æ­£å¸¸\n';
        logMessage += '  âœ… RLS ç­–ç•¥: æ­£å¸¸\n\n';
        logMessage += 'ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼è³‡æ–™åº«è¨­ç½®æ­£ç¢ºï¼Œå¯ä»¥é–‹å§‹ä½¿ç”¨æ‡‰ç”¨ç¨‹å¼äº†ã€‚\n';
        log(logMessage, 'success');

      } catch (error) {
        logMessage += `âŒ æ¸¬è©¦å¤±æ•—: ${error.message}\n\n`;
        logMessage += 'è«‹æª¢æŸ¥ï¼š\n';
        logMessage += '1. SQL è…³æœ¬æ˜¯å¦å·²æ­£ç¢ºåŸ·è¡Œ\n';
        logMessage += '2. RLS ç­–ç•¥æ˜¯å¦æ­£ç¢ºè¨­ç½®\n';
        logMessage += '3. ç’°å¢ƒè®Šæ•¸æ˜¯å¦æ­£ç¢ºé…ç½®\n';
        log(logMessage, 'error');
      }
    }
  </script>
</body>
</html>
