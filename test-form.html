<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¡¨å–®æäº¤æ¸¬è©¦</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 6px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 14px;
    }
    .success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>è¡¨å–®æäº¤æ¸¬è©¦å·¥å…·</h1>
    <p>æ­¤å·¥å…·æœƒè‡ªå‹•æäº¤æ¸¬è©¦è³‡æ–™åˆ° Supabase ä¸¦åŒæ­¥åˆ° Google Sheets</p>
    
    <button id="testBtn" onclick="testSubmission()">é–‹å§‹æ¸¬è©¦</button>
    <button onclick="checkGoogleSheets()">æª¢æŸ¥ Google Sheets</button>
    
    <div id="result"></div>
  </div>

  <script>
    const supabaseUrl = 'https://dhscdqpphloxzoyzytfz.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRoc2NkcXBwaGxveHpveXp5dGZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NzkxMzYsImV4cCI6MjA4NTA1NTEzNn0._YoLc5YweOMg2RfoZrYCBbgVXux-mfRRVeRbhUK01PA';
    const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbzIbMWSSwXtGJfQHDxGYj0SLVXQdVa3KW5IwGnFhUvsGnjtBNEduT7zI9SiHZARGmxCXg/exec';
    const spreadsheetId = '1cT3VJcDHyqHUEEdRfb7b9zMifBJk6f6upujGYV9dj4U';

    function log(message, type = 'info') {
      const result = document.getElementById('result');
      result.className = type;
      result.textContent = message;
      console.log(message);
    }

    function formatRegistration(reg) {
      return [
        '1',
        reg.ref_code,
        'å¤–éƒ¨å ±å',
        reg.headcount.toString(),
        '',
        reg.company || 'æœªå¡«å¯«',
        reg.title || '',
        reg.contact_name,
        reg.phone,
        reg.email || '',
        reg.line_id || '',
        'ä¸€èˆ¬',
        reg.diet_other || '',
        reg.allergy_note || '',
        reg.photo_consent ? 'æ˜¯' : 'å¦',
        reg.inviter || '',
        reg.vip_note || '',
        reg.invoice_needed ? 'æ˜¯' : 'å¦',
        reg.invoice_title || '',
        reg.invoice_tax_id || '',
        'è½‰å¸³',
        'å·²ä»˜æ¬¾',
        '',
        '',
        '',
        new Date(reg.created_at).toLocaleString('zh-TW'),
        new Date(reg.updated_at).toLocaleString('zh-TW'),
      ];
    }

    async function testSubmission() {
      const btn = document.getElementById('testBtn');
      btn.disabled = true;
      btn.textContent = 'æ¸¬è©¦ä¸­...';

      let logMessage = 'ğŸš€ é–‹å§‹æ¸¬è©¦è¡¨å–®æäº¤...\n\n';

      try {
        // æº–å‚™æ¸¬è©¦è³‡æ–™
        const timestamp = Date.now();
        const testData = {
          type: 'external',
          headcount: 1,
          attendee_list: [],
          company: 'æ¸¬è©¦å…¬å¸',
          title: 'æ¸¬è©¦è·ç¨±',
          contact_name: 'æ¸¬è©¦ç”¨æˆ¶' + timestamp,
          phone: '0912345678',
          email: `test${timestamp}@example.com`,
          line_id: '',
          diet: 'normal',
          diet_other: '',
          allergy_note: '',
          photo_consent: true,
          invoice_needed: false,
          invoice_title: '',
          invoice_tax_id: '',
          inviter: '',
          vip_note: '',
        };

        const refCode = 'TEST-' + timestamp.toString().slice(-6);

        // æ­¥é©Ÿ 1: æäº¤åˆ° Supabase
        logMessage += 'ğŸ“¤ æ­¥é©Ÿ 1: æäº¤åˆ° Supabase...\n';
        log(logMessage, 'info');

        const supabaseResponse = await fetch(`${supabaseUrl}/rest/v1/registrations?select=*`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': supabaseKey,
            'Authorization': `Bearer ${supabaseKey}`,
            'Prefer': 'return=representation',
          },
          body: JSON.stringify({
            ref_code: refCode,
            type: testData.type,
            headcount: testData.headcount,
            attendee_list: testData.attendee_list,
            company: testData.company || 'æœªå¡«å¯«',
            title: testData.title,
            contact_name: testData.contact_name,
            phone: testData.phone,
            email: testData.email,
            line_id: testData.line_id,
            diet: testData.diet,
            diet_other: testData.diet_other,
            allergy_note: testData.allergy_note,
            photo_consent: testData.photo_consent,
            invoice_needed: testData.invoice_needed,
            invoice_title: testData.invoice_title,
            invoice_tax_id: testData.invoice_tax_id,
            inviter: testData.inviter,
            vip_note: testData.vip_note,
            pay_method: 'transfer',
            pay_status: 'paid',
            pay_proof_url: null,
            status: 'open',
          }),
        });

        if (!supabaseResponse.ok) {
          const error = await supabaseResponse.text();
          throw new Error(`Supabase æäº¤å¤±æ•—: ${supabaseResponse.status} - ${error}`);
        }

        const registration = await supabaseResponse.json();
        logMessage += `âœ… Supabase æäº¤æˆåŠŸï¼\n`;
        logMessage += `   å ±åç·¨è™Ÿ: ${refCode}\n`;
        logMessage += `   è¯çµ¡äºº: ${testData.contact_name}\n\n`;
        log(logMessage, 'info');

        // æ­¥é©Ÿ 2: åŒæ­¥åˆ° Google Sheets
        logMessage += 'ğŸ“Š æ­¥é©Ÿ 2: åŒæ­¥åˆ° Google Sheets...\n';
        log(logMessage, 'info');

        const headers = [
          'åºè™Ÿ', 'å ±åç·¨è™Ÿ', 'å ±åé¡å‹', 'äººæ•¸', 'åƒèˆ‡è€…åå–®', 'å…¬å¸', 'è·ç¨±',
          'è¯çµ¡äºº', 'é›»è©±', 'Email', 'LINE ID', 'é£²é£Ÿéœ€æ±‚', 'å…¶ä»–é£²é£Ÿéœ€æ±‚',
          'éæ•å‚™è¨»', 'ç…§ç‰‡åŒæ„', 'é‚€è«‹äºº', 'VIP å‚™è¨»', 'éœ€è¦ç™¼ç¥¨', 'ç™¼ç¥¨æŠ¬é ­',
          'çµ±ä¸€ç·¨è™Ÿ', 'ä»˜æ¬¾æ–¹å¼', 'ä»˜æ¬¾ç‹€æ…‹', 'åº§ä½å€åŸŸ', 'æ¡Œè™Ÿ', 'ç®¡ç†å“¡å‚™è¨»',
          'å»ºç«‹æ™‚é–“', 'æ›´æ–°æ™‚é–“',
        ];

        const requestBody = {
          spreadsheetId: spreadsheetId,
          sheetName: 'å·¥ä½œè¡¨1',
          values: [headers, formatRegistration(registration[0])],
        };

        logMessage += `ğŸ“¤ ç™¼é€è«‹æ±‚åˆ° Google Apps Script...\n`;
        logMessage += `   è«‹æ±‚è³‡æ–™å¤§å°: ${JSON.stringify(requestBody).length} bytes\n`;
        log(logMessage, 'info');

        const sheetsResponse = await fetch(appsScriptUrl, {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json',
          },
          redirect: 'follow',
          body: JSON.stringify(requestBody),
        });

        logMessage += `ğŸ“¥ Google Apps Script éŸ¿æ‡‰ç‹€æ…‹: ${sheetsResponse.status} ${sheetsResponse.statusText}\n`;
        log(logMessage, 'info');

        const responseText = await sheetsResponse.text();
        logMessage += `ğŸ“„ éŸ¿æ‡‰å…§å®¹: ${responseText.substring(0, 200)}...\n\n`;

        if (sheetsResponse.ok) {
          try {
            const result = JSON.parse(responseText);
            if (result.success) {
              logMessage += 'âœ… Google Sheets åŒæ­¥æˆåŠŸï¼\n\n';
              logMessage += 'ğŸ“Š æ¸¬è©¦çµæœç¸½çµ:\n';
              logMessage += '  âœ… Supabase æäº¤: æˆåŠŸ\n';
              logMessage += '  âœ… Google Sheets åŒæ­¥: æˆåŠŸ\n';
              logMessage += `  ğŸ“ å ±åç·¨è™Ÿ: ${refCode}\n`;
              logMessage += `  ğŸ‘¤ è¯çµ¡äºº: ${testData.contact_name}\n\n`;
              logMessage += 'ğŸ”— è«‹æª¢æŸ¥ Google Sheets ç¢ºèªè³‡æ–™æ˜¯å¦å·²å¯«å…¥:\n';
              logMessage += `https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit\n`;
              log(logMessage, 'success');
            } else {
              logMessage += `âŒ Google Sheets åŒæ­¥å¤±æ•—: ${result.error || result.message}\n`;
              log(logMessage, 'error');
            }
          } catch (parseError) {
            logMessage += `âŒ è§£æéŸ¿æ‡‰å¤±æ•—: ${parseError.message}\n`;
            logMessage += `åŸå§‹éŸ¿æ‡‰: ${responseText}\n`;
            
            if (responseText.includes('CORS') || responseText.includes('Access-Control')) {
              logMessage += '\nâš ï¸ CORS éŒ¯èª¤ï¼šè«‹ç¢ºèª Google Apps Script éƒ¨ç½²è¨­ç½®\n';
              logMessage += '1. é»æ“Šã€Œéƒ¨ç½²ã€>ã€Œç®¡ç†éƒ¨ç½²ä½œæ¥­ã€\n';
              logMessage += '2. ç·¨è¼¯éƒ¨ç½²\n';
              logMessage += '3. ã€Œå…·æœ‰å­˜å–æ¬Šçš„ä½¿ç”¨è€…ã€è¨­ç‚ºã€Œä»»ä½•äººã€\n';
              logMessage += '4. é¸æ“‡ã€Œæ–°å¢ç‰ˆæœ¬ã€ä¸¦æ›´æ–°\n';
            }
            log(logMessage, 'error');
          }
        } else {
          logMessage += `âŒ Google Sheets åŒæ­¥å¤±æ•—: HTTP ${sheetsResponse.status}\n`;
          logMessage += `éŸ¿æ‡‰å…§å®¹: ${responseText.substring(0, 200)}\n`;
          log(logMessage, 'error');
        }

      } catch (error) {
        logMessage += `âŒ æ¸¬è©¦å¤±æ•—: ${error.message}\n`;
        if (error.stack) {
          logMessage += `å †ç–Š: ${error.stack}\n`;
        }
        log(logMessage, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'é–‹å§‹æ¸¬è©¦';
      }
    }

    function checkGoogleSheets() {
      window.open(`https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`, '_blank');
    }
  </script>
</body>
</html>
