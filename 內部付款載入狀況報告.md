# 內部付款頁「載入報名名單」狀況報告

## 一、Supabase 資料庫檢查結果 ✅ 正常

| 檢查項目 | 結果 |
|----------|------|
| 資料筆數 | 內部＋未付款：54 筆 ✓ |
| RLS 政策 | `huadrink_Anyone can view`（SELECT 開放給所有人）✓ |
| 權限 | anon、authenticated 皆可 SELECT ✓ |
| Schema 開放 | `pgrst.db_schemas` 已包含 `public, huadrink` ✓ |
| 索引 | `idx_registrations_type_pay_status` 已建立 ✓ |

**本機診斷**（`npm run diagnose-supabase`）：
- system_settings：成功 161ms
- registrations（內部＋未付款）：成功 141ms，54 筆

→ **Supabase 與資料庫讀取正常，非後端問題。**

---

## 二、前端讀取流程

```
Payment.tsx → usePaymentEligibleRegistrations()
    → huadrink.from('registrations')
        .select('id, ref_code, contact_name, type, pay_status')
        .eq('type', 'internal')
        .eq('pay_status', 'unpaid')
    → Supabase API (anon key)
    → 逾時設定：15 秒
```

---

## 三、可能失敗原因（由前往後）

| 原因 | 說明 | 建議作法 |
|------|------|----------|
| **1. 生產環境變數** | Cloudflare Pages 未設定或錯誤的 `VITE_SUPABASE_URL`、`VITE_SUPABASE_PUBLISHABLE_KEY` | 到 Cloudflare Pages → 專案 → Settings → Environment variables 檢查並重新建置 |
| **2. 網路延遲／逾時** | 夥伴端到 Supabase 連線慢，超過 15 秒 | 請夥伴開 F12 → Network，查看 `registrations` 請求是 Pending 或失敗 |
| **3. 防火牆／封鎖** | 公司網路、部分 ISP、或瀏覽器擴充功能阻擋 Supabase 請求 | 換 4G 或家用網路、關閉廣告／隱私擋廣告擴充 |
| **4. Supabase 休眠** | Free tier 專案閒置後會休眠，首個請求較慢 | 等 30 秒後重新整理，或改用 Pro 方案 |

---

## 四、夥伴端簡易自我檢查

請夥伴在內部付款頁操作：

1. 按 **F12** 開啟開發者工具
2. 切到 **Network（網路）** 分頁
3. 重新整理頁面
4. 在篩選輸入 `registrations` 或 `rest`
5. 查看相關請求：
   - **Status 200**：請求成功，可能是前端錯誤
   - **Status 4xx/5xx**：後端或權限問題
   - **Pending 很久**：網路延遲或 Supabase 回應慢

---

## 五、結論

- **資料庫**：設定、權限、RLS、索引皆正確
- **本機**：診斷腳本可成功讀取
- **推測**：生產環境變數或夥伴端網路／環境導致載入失敗

**建議優先**：檢查 Cloudflare Pages 的 `VITE_SUPABASE_URL`、`VITE_SUPABASE_PUBLISHABLE_KEY` 是否正確並已套用，然後重新部署。
