# 注意事項：付款上傳與營運

## 一、付款憑證上傳（已做的優化）

- **自動壓縮**：選圖超過 100KB 會先壓縮，送出時若仍 > 200KB 會再壓一次，避免大 PNG 原檔上傳卡住。
- **逾時**：上傳約 90 秒、寫入約 20 秒逾時會提示，不會無限轉圈。
- **單檔上限**：建議 8MB 以內，超過會提示。
- **切換報名者會清掉已選圖片**：選了 A 再改選 B 時，已選的圖片會自動清掉，必須重新選圖，避免同一張圖被套用到多筆報名（後台看到重複憑證）。

若使用者仍反映「一直轉圈」：請他確認有看到「已壓縮」或等逾時提示；若常逾時，可檢查網路或 Supabase 專案狀態。

---

## 二、環境與部署

| 項目 | 說明 |
|------|------|
| **本機開發** | 根目錄要有 `.env`，內含 `VITE_SUPABASE_URL`、`VITE_SUPABASE_PUBLISHABLE_KEY`；改動後需**重開** `npm run dev`。 |
| **正式環境（如 Cloudflare Pages）** | 在部署平台設定上述兩個變數，或改為本機 `npm run deploy`（用本機 `.env` 建置再上傳）。 |
| **勿提交 .env** | `.env` 已在 `.gitignore`，不要把真實金鑰推上 Git。 |

---

## 三、安全性（可之後加強）

- **payment-proofs**：目前 anon 可上傳到任意 `{registrationId}/proof.*`。若擔心被猜 ID 覆蓋他人憑證，可改為 Supabase Storage RLS 或 Edge Function 驗證該筆報名存在且為 internal + unpaid 再允許上傳。
- **管理員**：用 service_role 建立管理員後，建議立刻改密碼，並限制 service_role 僅在必要腳本使用。

---

## 四、營運與資料

- **活動／匯款截止日**：若 `constants.ts` 或後台有寫死截止日（如 2/7），活動後記得更新或改為後台設定。
- **成員名單**：`src/lib/members.ts` 為硬編碼；若常異動，可考慮改為後台或 Google Sheets 等動態來源。
- **付款頁與後台不同步**：後台審核付款狀態後，若付款頁仍顯示「待付款」，多半是快取；重新整理或等 invalidate 即可。若你有自訂更新邏輯，記得同時 invalidate `['registrations','payment-eligible']`。

---

## 五、其他

- **Supabase 中斷**：系統完全依賴 Supabase，若服務中斷會無法上傳／查詢；目前已有逾時與錯誤提示，必要時可再加離線提示或重試。
- **上傳頻率**：目前前端有防重複送出（按鈕 disabled）；若擔心濫用，可在 Supabase RPC 或 Edge Function 做簡易頻率限制。

有問題可先對照 `CONNECTION_SETUP.md`、`注意事項.md` 與本檔案。

---

## 六、其它注意事項

| 項目 | 說明 |
|------|------|
| **報名截止日／活動資訊** | `src/lib/constants.ts` 的 `EVENT_INFO.deadline`、`PAYMENT_INSTRUCTIONS` 等若寫死日期，活動後記得更新或改為後台設定。 |
| **成員名單** | `src/lib/members.ts` 為硬編碼（約 80 筆）；新增／異動需改程式。若常異動可改為後台或 Google Sheets 動態載入。 |
| **Google Sheets ID** | `googleSheets.ts`、`membersGoogleSheets.ts` 的 Spreadsheet ID 若寫死，換專案時需改程式或改為環境變數 `VITE_GOOGLE_SHEETS_ID`。 |
| **管理員建立** | 用 `scripts/setup-admin.js` 或 SQL 建立管理員後，建議立刻在後台改密碼；`SUPABASE_SERVICE_ROLE_KEY` 僅用於腳本，勿放進前端或打包。 |
| **已付款改回未付款** | 後台會一併清除該筆的付款憑證（圖片、末五碼）並**刪除 Storage 內該筆憑證檔案**，無法復原。需執行 migration `20260204150000_storage_delete_payment_proofs.sql` 讓已登入管理員具備刪除權限。 |
| **詳情 modal 顯示舊資料** | 後台更新某筆報名後，若詳情 modal 仍顯示舊資料，多半是 React Query 快取；重新打開或重新整理即可。必要時可讓 `useUpdateRegistration` 同時 invalidate 該筆 `['registration', id]`。 |

---

## 七、可能遇到的問題與對策

### 畫面／連線

| 現象 | 可能原因 | 對策 |
|------|----------|------|
| **重整（F5）後一直載入、付款頁／後台卡住** | 重整後首筆請求逾時或無回應 | 報名列表／付款名單約 **20 秒** 逾時會顯示「載入逾時」並出現 **重試** 按鈕；後台列表逾時會顯示黃色提示列＋重試。Auth 約 **6 秒**、admins 查詢約 **8 秒** 逾時會結束載入，避免無限轉圈。 |
| **閒置過久後回到分頁就卡在載入** | React Query 預設「視窗重新取得焦點」會自動 refetch；閒置後連線冷卻，該請求易卡住 | 已關閉 **refetchOnWindowFocus**（`QueryClient` 預設），回到分頁不會自動重拉，避免一回來就觸發卡住的請求。若要更新資料可手動點「重試」或重整頁面。 |
| **白畫面、完全沒內容** | 環境變數未載入、建置缺 `VITE_*`、JavaScript 錯誤 | 看 `BLANK_SCREEN_TROUBLESHOOTING.md`；確認 `.env` 存在且改動後有重開 dev；F12 Console 看錯誤。 |
| **上傳／登入一直轉圈** | 網路慢、Supabase 逾時、Storage/RPC 無回應 | 付款頁已有 90s／20s 逾時；若常發生可檢查 Supabase 專案狀態、網路；大圖會先壓縮再傳。 |
| **部署後「缺少環境變數」或連到 placeholder** | 部署平台未設定 `VITE_SUPABASE_URL`、`VITE_SUPABASE_PUBLISHABLE_KEY` | 到 Cloudflare Pages（或所用平台）Environment variables 新增兩變數後 Redeploy；或改為本機 `npm run deploy`。 |
| **API 500、Invalid schema: huadrink** | 新專案未執行 huadrink schema 或 API 未開放 huadrink | 執行 `supabase/huadrink-setup.sql`、`supabase/huadrink-expose-schema.sql`；見 `設定新資料庫.md`。 |
| **CORS 錯誤** | Supabase 專案未允許該網域、或 URL 打錯 | 見 `CORS_FIX_INSTRUCTIONS.md`；Supabase Dashboard → Authentication → URL Configuration 檢查 Site URL／Redirect URLs。 |

### 登入／權限

| 現象 | 可能原因 | 對策 |
|------|----------|------|
| **登入成功但進不了後台** | `huadrink.admins` 沒有對應的 `user_id`（auth.uid()） | 用腳本或 SQL 在 `huadrink.admins` 新增該使用者的 `user_id`；見 `create_admin_account.sql`、`scripts/setup-admin.js`。 |
| **登入狀態怪怪的（有時已登出）** | 勾選「記住登入」用 localStorage，未勾選用 sessionStorage；逾時或換分頁 | 見 `AUTH_登入狀態檢查.md`；登出再登入一次。 |

### 資料／顯示

| 現象 | 可能原因 | 對策 |
|------|----------|------|
| **後台改付款狀態後，付款頁仍顯示舊的** | React Query 快取未 invalidate | 重新整理付款頁；或確認 `useUpdateRegistration` 有 invalidate `['registrations','payment-eligible']`。 |
| **多筆報名顯示同一張憑證圖** | 付款頁切換報名者時沒重新選圖，同一張圖被傳到多筆 | 已修正：切換報名者會清掉已選圖片；既有錯套資料需在後台手動改狀態或請當事人重傳。 |
| **列表載入很慢** | 查詢筆數多、或載入 pay_proof_base64 | 列表已不載入 base64；若仍慢可加索引、分頁或篩選。 |

### 瀏覽器／裝置

| 現象 | 可能原因 | 對策 |
|------|----------|------|
| **手機上傳圖片失敗或卡住** | 檔案大、網路不穩、Safari/Chrome 差異 | 已做壓縮與逾時；請用 Wi‑Fi 或壓縮後再試；必要時換瀏覽器。 |
| **拍照上傳後方向錯誤** | 手機 EXIF 旋轉未套用 | 壓縮時用 Canvas 繪圖多數會依 EXIF；若仍錯可考慮在前端讀 EXIF 再旋轉。 |

### 維護與程式

| 項目 | 說明 |
|------|------|
| **React Query** | 專案已用 `gcTime`（v5）；若升級套件注意 breaking changes。 |
| **Dead code** | `Step3Form`、`supabaseFetch.ts` 若已刪除可略過；若有類似未使用檔案可定期清理。 |
| **重複邏輯** | `sortByMemberId`、`generateRefCode` 等若多處相同可抽成 `lib/registrations.ts`、`lib/refCode.ts` 以利維護。 |

更完整的技術檢視與優先順序見 `PROJECT_REVIEW.md`。
